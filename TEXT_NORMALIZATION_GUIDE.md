# Text Normalization（文本正则化）使用指南

## 什么是文本正则化？

文本正则化（Text Normalization）是将原始文本转换为更适合语音合成的标准化格式的过程。VoxCPM 使用 **WeText** 库进行文本正则化处理。

## 文本正则化的功能

根据代码实现，文本正则化会进行以下处理：

### 1. **清理文本格式**
- 去除 Markdown 语法（代码块、链接、图片等）
- 去除表情符号
- 去除多余的换行符和制表符
- 清理 HTML 标签

### 2. **中文文本处理**（当检测到中文时）
- 数字转中文：`123` → `一百二十三`
- 符号转换：`²` → `平方`，`³` → `立方`，`√` → `根号`
- 数学符号：`≈` → `约等于`，`<` → `小于`，`=` → `等于`
- 去除括号和特殊符号
- 处理中英文混排的空格

### 3. **英文文本处理**（纯英文文本）
- 数字转英文单词：`123` → `one hundred twenty-three`
- 标准英文文本正则化

## 什么时候需要开启？

### ✅ **建议开启的情况：**

1. **包含数字的文本**
   ```
   原始：今天温度是25度
   正则化后：今天温度是二十五度
   ```

2. **包含数学公式或符号**
   ```
   原始：2² + 3² = 13
   正则化后：二平方加三平方等于十三
   ```

3. **包含特殊符号**
   ```
   原始：价格 < 100元
   正则化后：价格小于一百元
   ```

4. **从网页或文档复制的文本**
   - 包含 Markdown 格式
   - 包含 HTML 标签
   - 包含链接和图片引用

5. **包含表情符号的文本**
   ```
   原始：今天天气真好😊
   正则化后：今天天气真好
   ```

6. **格式不规范的文本**
   - 包含多余的空格和换行
   - 包含特殊字符

### ❌ **不建议开启的情况：**

1. **使用音素输入时**
   ```
   原始：{ni3}{hao3}  # 中文拼音音素
   正则化后：可能会破坏音素格式
   ```
   VoxCPM 原生支持音素输入，开启正则化可能会干扰音素处理。

2. **使用 CMUDict 音素输入时**
   ```
   原始：{HH AH0 L OW1}  # 英文 CMUDict 音素
   正则化后：可能会破坏音素格式
   ```

3. **需要保留原始格式的文本**
   - 包含特殊标记的文本
   - 需要精确控制的文本

4. **文本已经规范化**
   - 纯文本，无特殊符号
   - 已经手动处理过的文本

## 使用示例

### 示例 1：包含数字和符号（建议开启）

```python
from voxcpm import VoxCPM

model = VoxCPM.from_pretrained("openbmb/VoxCPM1.5")

# 开启正则化
text = "今天温度是25度，价格<100元"
wav = model.generate(
    text=text,
    normalize=True,  # 开启正则化
)
# 处理为：今天温度是二十五度，价格小于一百元

# 不开启正则化
wav = model.generate(
    text=text,
    normalize=False,  # 不开启正则化
)
# 保持原样：今天温度是25度，价格<100元
```

### 示例 2：使用音素输入（不建议开启）

```python
# 中文音素输入
text = "{ni3}{hao3}{shi4}{jie4}"  # 你好世界

wav = model.generate(
    text=text,
    normalize=False,  # 必须关闭，否则会破坏音素格式
)
```

### 示例 3：从网页复制的文本（建议开启）

```python
text = """
# 标题

这是正文内容，包含[链接](url)和`代码`。

价格：$99.99
"""

wav = model.generate(
    text=text,
    normalize=True,  # 开启正则化，清理 Markdown 格式
)
```

## 在 Web 界面中使用

在 Web 界面中，可以通过 **"Text Normalization"** 复选框控制：

- ✅ **勾选**：启用文本正则化
- ❌ **不勾选**：使用 VoxCPM 原生文本理解能力（支持音素输入等）

## 性能影响

- **开启正则化**：会增加少量处理时间（通常 < 100ms）
- **关闭正则化**：使用 VoxCPM 内置文本理解，速度更快

## 总结

| 场景 | 建议设置 |
|------|---------|
| 包含数字、符号 | ✅ 开启 |
| 从网页/文档复制 | ✅ 开启 |
| 包含表情符号 | ✅ 开启 |
| 使用音素输入 | ❌ 关闭 |
| 纯文本，已规范化 | ❌ 关闭 |
| 需要精确控制 | ❌ 关闭 |

**一般建议**：如果不确定，可以先尝试**不开启**正则化，因为 VoxCPM 的原生文本理解能力很强。如果发现数字、符号等处理不正确，再开启正则化。
